<!DOCTYPE html>
<html lang="vi" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác thực OTP - Chat Cloud</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .card-otp {
            border-radius: 20px;
            border: none;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.98);
            max-width: 500px;
            margin: 0 auto;
        }

        .card-header-gradient {
            background: var(--gradient-secondary);
            padding: 2.5rem 1.5rem;
        }

        .otp-input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 2rem 0;
        }

        .otp-input {
            width: 60px;
            height: 70px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .otp-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
            outline: none;
        }

        .otp-input.filled {
            border-color: var(--primary-color);
            background-color: #eef2ff;
        }

        .btn-primary-custom {
            background: var(--gradient-secondary);
            border: none;
            padding: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-outline-custom {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-custom:hover {
            background: var(--primary-color);
            color: white;
        }

        .flash-message {
            border-radius: 10px;
            border-left: 5px solid #dc3545;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: #f8d7da;
            color: #721c24;
        }

        .flash-message.success {
            background-color: #d1fae5;
            border-left-color: #10b981;
            color: #065f46;
        }

        .countdown {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            display: inline-block;
            min-width: 50px;
        }

        .otp-illustration {
            max-width: 60%;
            height: auto;
        }

        @media (max-width: 576px) {
            .otp-input {
                width: 50px;
                height: 60px;
                font-size: 1.5rem;
            }

            .otp-illustration {
                max-width: 50%;
            }
        }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="card card-otp">
                    <!-- Header -->
                    <div class="card-header-gradient text-center text-white">
                        <h1 class="h2 fw-bold mb-2"><i class="fas fa-shield-alt me-2"></i> Xác thực OTP</h1>
                        <p class="mb-0 opacity-90">Bảo vệ tài khoản của bạn</p>
                    </div>

                    <!-- Body -->
                    <div class="card-body p-4 p-md-5">
                        <!-- Illustration -->
                        <div class="text-center mb-4">
                            <img src="https://cdn-icons-png.flaticon.com/512/4345/4345716.png" alt="OTP Illustration" class="otp-illustration">
                        </div>

                        <!-- Flash Messages -->
                        {% with messages = get_flashed_messages() %}
                            {% if messages %}
                                <div class="flash-messages">
                                    {% for msg in messages %}
                                        <div class="flash-message {% if 'thành công' in msg|lower %}success{% endif %} d-flex align-items-center">
                                            <i class="fas {% if 'thành công' in msg|lower %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} me-2"></i>
                                            <span>{{ msg }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endwith %}

                        <!-- Instructions -->
                        <div class="text-center mb-4">
                            <h3 class="h5 fw-bold">Nhập mã xác thực</h3>
                            <p class="text-muted">
                                Chúng tôi đã gửi mã xác thực (OTP) gồm 6 chữ số đến số điện thoại của bạn.
                                Vui lòng nhập mã để hoàn tất đăng ký.
                            </p>
                        </div>

                        <!-- OTP Form -->
                        <form method="POST" id="otpForm">
                            <!-- OTP Inputs -->
                            <div class="otp-input-container">
                                <input type="text" class="otp-input" maxlength="1" data-index="1" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" data-index="2" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" data-index="3" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" data-index="4" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" data-index="5" autocomplete="off">
                                <input type="text" class="otp-input" maxlength="1" data-index="6" autocomplete="off">
                            </div>

                            <!-- Hidden input for the complete OTP -->
                            <input type="hidden" name="otp" id="otp">

                            <!-- Countdown Timer -->
                            <div class="text-center mb-4">
                                <p class="text-muted">
                                    Mã OTP sẽ hết hạn sau:
                                    <span class="countdown" id="countdown">05:00</span>
                                </p>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-primary-custom btn-lg fw-bold" id="submitBtn" disabled>
                                    <i class="fas fa-check-circle me-2"></i> Xác thực
                                </button>
                            </div>

                            <!-- Resend OTP -->
                            <div class="text-center">
                                <p class="text-muted mb-2">Không nhận được mã?</p>
                                <button type="button" class="btn btn-outline-custom" id="resendBtn" disabled>
                                    <i class="fas fa-redo me-1"></i> Gửi lại mã
                                    <span id="resendTimer" class="ms-1">(120s)</span>
                                </button>
                            </div>
                        </form>

                        <!-- Back to Login -->
                        <div class="text-center mt-4 pt-3 border-top">
                            <p class="mb-0">
                                <a href="{{ url_for('login') }}" class="text-decoration-none">
                                    <i class="fas fa-arrow-left me-1"></i> Quay lại đăng nhập
                                </a>
                            </p>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="card-footer text-center py-3 bg-light">
                        <p class="small text-muted mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            Mã OTP chỉ có hiệu lực trong 5 phút. Vui lòng không chia sẻ mã với bất kỳ ai.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // OTP Input Handling
        const otpInputs = document.querySelectorAll('.otp-input');
        const otpHiddenInput = document.getElementById('otp');
        const submitBtn = document.getElementById('submitBtn');

        otpInputs.forEach((input, index) => {
            // Focus on first input
            if (index === 0) input.focus();

            // Handle input
            input.addEventListener('input', function(e) {
                const value = this.value;

                // Only allow numbers
                if (!/^\d*$/.test(value)) {
                    this.value = '';
                    return;
                }

                // If a number is entered, move to next input
                if (value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }

                // Update the hidden input
                updateOTPValue();

                // Update visual state
                if (value) {
                    this.classList.add('filled');
                } else {
                    this.classList.remove('filled');
                }
            });

            // Handle backspace
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });

            // Handle paste
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text').trim();

                if (/^\d{6}$/.test(pasteData)) {
                    for (let i = 0; i < otpInputs.length; i++) {
                        if (i < pasteData.length) {
                            otpInputs[i].value = pasteData[i];
                            otpInputs[i].classList.add('filled');
                        }
                    }

                    // Focus the last input
                    if (pasteData.length === otpInputs.length) {
                        otpInputs[otpInputs.length - 1].focus();
                    }

                    updateOTPValue();
                }
            });
        });

        function updateOTPValue() {
            let otp = '';
            otpInputs.forEach(input => {
                otp += input.value;
            });

            otpHiddenInput.value = otp;

            // Enable submit button if OTP is complete
            submitBtn.disabled = otp.length !== otpInputs.length;
        }

        // Countdown Timer
        let countdownTime = 5 * 60; // 5 minutes in seconds
        let resendTime = 120; // 2 minutes in seconds
        const countdownElement = document.getElementById('countdown');
        const resendBtn = document.getElementById('resendBtn');
        const resendTimerElement = document.getElementById('resendTimer');

        function updateCountdown() {
            const minutes = Math.floor(countdownTime / 60);
            const seconds = countdownTime % 60;
            countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (countdownTime <= 0) {
                clearInterval(countdownInterval);
                countdownElement.textContent = 'Hết hạn';
                countdownElement.style.color = '#dc3545';
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> Mã đã hết hạn';
            }

            countdownTime--;
        }

        function updateResendTimer() {
            resendTimerElement.textContent = `(${resendTime}s)`;

            if (resendTime <= 0) {
                clearInterval(resendTimerInterval);
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo me-1"></i> Gửi lại mã';
                resendTimerElement.textContent = '';
            }

            resendTime--;
        }

        // Start timers
        const countdownInterval = setInterval(updateCountdown, 1000);
        const resendTimerInterval = setInterval(updateResendTimer, 1000);

        // Initial update
        updateCountdown();
        updateResendTimer();

        // Resend OTP button
        resendBtn.addEventListener('click', function() {
            if (!this.disabled) {
                // Reset OTP inputs
                otpInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled');
                });
                otpHiddenInput.value = '';
                submitBtn.disabled = true;

                // Reset timers
                countdownTime = 5 * 60;
                resendTime = 120;
                countdownElement.style.color = '#6366f1';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> Xác thực';

                // Show success message
                alert('Mã OTP mới đã được gửi đến số điện thoại của bạn.');

                // Focus first input
                otpInputs[0].focus();

                // Update UI
                updateCountdown();
                updateResendTimer();

                // Restart intervals
                clearInterval(countdownInterval);
                clearInterval(resendTimerInterval);

                setInterval(updateCountdown, 1000);
                setInterval(updateResendTimer, 1000);

                // Disable resend button again
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-redo me-1"></i> Gửi lại mã <span id="resendTimer" class="ms-1">(120s)</span>';
            }
        });

        // Form validation
        document.getElementById('otpForm').addEventListener('submit', function(e) {
            const otp = otpHiddenInput.value;

            if (otp.length !== 6) {
                alert('Vui lòng nhập đầy đủ 6 chữ số OTP.');
                e.preventDefault();
                return;
            }

            if (!/^\d{6}$/.test(otp)) {
                alert('OTP chỉ được chứa các chữ số từ 0-9.');
                e.preventDefault();
                return;
            }

            if (countdownTime <= 0) {
                alert('Mã OTP đã hết hạn. Vui lòng yêu cầu mã mới.');
                e.preventDefault();
                return;
            }
        });
    </script>
</body>
</html>